<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Arcano</title>
    
    <!-- Tailwind CSS para o estilo -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fontes do Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Estilos customizados -->
    <style>
        body { background-color: #0f172a; }
        .font-fancy { font-family: 'Cinzel', serif; }
        .font-sans { font-family: 'Inter', sans-serif; }
        .animate-spin-slow { animation: spin 3s linear infinite; }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .glass-effect { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(51, 65, 85, 0.4); }
        
        /* NOVO: Estilo para o canvas de partículas */
        #particle-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0; /* Coloca o canvas atrás de todo o conteúdo */
            pointer-events: none; /* Garante que o canvas não interfere com cliques */
        }

        .prose-custom {
            white-space: pre-wrap; 
            word-wrap: break-word;   
        }
        .prose-custom h2 { color: #c4b5fd; font-family: 'Cinzel', serif; margin-top: 1.5em; border-bottom: 1px solid #4a044e; padding-bottom: 0.3em; }
        .prose-custom h3 { color: #a5b4fc; font-family: 'Cinzel', serif; margin-top: 1.5em; font-size: 1.25rem; }
        .prose-custom p, .prose-custom li { color: #d1d5db; line-height: 1.7; margin-top: 1em; }
        .prose-custom b { font-weight: bold; color: #e5e7eb; }
        .prose-custom textarea { height: 150px; }
        .quote-yellow { color: #facc15; }
    </style>
</head>
<body class="font-sans text-gray-300">

    <!-- Fundo de estrelas estático -->
    <div class="absolute top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-10 z-0"></div>
    
    <!-- NOVO: Canvas para as partículas animadas -->
    <canvas id="particle-canvas"></canvas>

    <!-- Conteúdo principal da aplicação -->
    <main id="app-container" class="relative z-10 container mx-auto p-4 sm:p-6 md:p-8"></main>

    <!-- Firebase SDKs (Versão Atualizada) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, getDocs, where, limit, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // CONFIGURAÇÃO DO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCAIQdjGBzPWulP2KQcHHmI2r3FgpTfsfg",
            authDomain: "portalarcano-9a0fa.firebaseapp.com",
            projectId: "portalarcano-9a0fa",
            storageBucket: "portalarcano-9a0fa.appspot.com",
            messagingSenderId: "139414169635",
            appId: "1:139414169635:web:31e3a9669c6c08566a2996",
            measurementId: "G-V5SLG68Z6M"
        };
        
        // Definição das Sessões/Cursos
        const SESSIONS = {
            'vip-bruxaria-luna': 'VIP Bruxaria - Sacerdotisa Luna',
            'vip-magia-oriental-akane': 'VIP Magia Oriental - Soror Akane',
            'vip-oraculos-amicta-solle': 'VIP Oráculos - Soror Amicta Solle',
            'vip-mediunidades': 'VIP Mediunidades',
            'magia-planetaria-max': 'Magia Planetária - Frater Max',
            'magia-goecia-max': 'Magia Goecia - Frater Max',
            'vip-lux-1': 'VIP LUX I - Soror B.N.HellLux',
            'vip-lux-2-3': 'VIP LUX II & III - Soror B.N.HellLux'
        };

        const appIdName = 'default-grimorio-pago-html';
        const appContainer = document.getElementById('app-container');
        let db, currentUser = null, currentClasses = [], isAdminPanelVisible = false, confirmationTimeout = null;

        const simpleHash = (str) => {
            let hash = 0;
            if (str.length === 0) return hash.toString();
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = (hash << 5) - hash + char;
                hash |= 0;
            }
            return hash.toString();
        };

        const autoFormatText = (text) => {
            if (!text) return '';
            let safeText = text.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            safeText = safeText.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            safeText = safeText.replace(/"(.*?)"/g, '<span class="quote-yellow">"$1"</span>');
            const lines = safeText.split(/\r?\n/);
            return lines.map(line => {
                if (/^\d+\.\s.*$/.test(line.trim()) || /^[A-Z\sÇÃÕÉ?]+$/.test(line.trim())) {
                    return `<h3>${line.trim()}</h3>`;
                }
                if (line.trim() === '') return '<br>';
                return `<p>${line}</p>`;
            }).join('');
        };

        async function main() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                setupParticleCanvas(); // Inicia a animação de partículas
                await setupInitialAdminUser();
                render(LoginView());
            } catch (error) {
                console.error("ERRO CRÍTICO NA INICIALIZAÇÃO DO FIREBASE:", error);
                appContainer.innerHTML = `<div class="text-center text-red-400 p-8">Erro Crítico. Verifique a consola.</div>`;
            }
        }

        const render = (template) => {
            appContainer.innerHTML = template;
            attachEventListeners();
        };
        
        const LoginView = (error = '', loading = false) => `
            <div class="flex items-center justify-center min-h-[90vh]">
                <div class="w-full max-w-md p-8 space-y-6 rounded-2xl shadow-2xl shadow-purple-950/40 glass-effect">
                    <div class="text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto h-12 w-12 text-purple-400"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
                        <h1 class="text-4xl font-fancy mt-4 text-purple-200">Portal Arcano</h1>
                    </div>
                    <form id="login-form" class="space-y-4">
                        ${error ? `<p class="bg-red-900/50 text-red-300 border border-red-700 p-3 rounded-lg text-center font-semibold">${error}</p>` : ''}
                        <input name="email" type="email" required class="w-full px-4 py-3 text-gray-200 bg-slate-800/80 rounded-lg" placeholder="seu.email@arcano.com" />
                        <input name="password" type="password" required class="w-full px-4 py-3 text-gray-200 bg-slate-800/80 rounded-lg" placeholder="••••••••" />
                        <button type="submit" ${loading ? 'disabled' : ''} class="w-full py-3 font-bold text-lg text-white bg-purple-700 rounded-lg hover:bg-purple-800 transition disabled:bg-slate-600">
                            ${loading ? 'Invocando...' : 'Entrar'}
                        </button>
                    </form>
                </div>
            </div>
        `;

        const DashboardView = () => `
            <div class="animate-fade-in">
                <header class="flex justify-between items-center mb-10 pb-4 border-b border-slate-700/50">
                    <h1 class="text-3xl md:text-4xl font-fancy text-purple-200">Seu Grimório</h1>
                    <div class="flex items-center gap-3">
                        ${currentUser?.isAdmin ? `<button id="toggle-admin-panel" title="Painel do Arcanista" class="p-2 font-semibold text-white rounded-full transition-colors ${isAdminPanelVisible ? 'bg-purple-600' : 'bg-green-700 hover:bg-green-600'}"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 18v3c0 .6.4 1 1 1h4v-3h3v-3h2l1.4-1.4a6.5 6.5 0 1 0-4-4Z"/><circle cx="16.5" cy="7.5" r=".5"/></svg></button>` : ''}
                        <button id="logout-btn" class="px-4 py-2 font-semibold text-purple-200 bg-slate-800 rounded-lg hover:bg-slate-700">Sair</button>
                    </div>
                </header>
                <div id="admin-panel-container">${currentUser?.isAdmin && isAdminPanelVisible ? AdminPanel() : ''}</div>
                <div id="classes-grid" class="space-y-12 mt-8">
                     ${Object.keys(SESSIONS).filter(key => currentUser?.isAdmin || currentUser?.accessibleSections?.includes(key)).map(sessionId => `
                        <div>
                            <h2 class="text-2xl font-fancy text-purple-300 border-b-2 border-purple-800/50 pb-2 mb-6">${SESSIONS[sessionId]}</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                                ${currentClasses.filter(c => c.sectionId === sessionId).map(c => `
                                    <div data-class-id="${c.id}" class="class-card group relative p-6 rounded-xl shadow-lg cursor-pointer transition-all duration-300 hover:shadow-purple-800/40 hover:-translate-y-2 glass-effect">
                                        ${currentUser?.isAdmin ? `<button data-delete-id="${c.id}" class="delete-post-btn absolute top-2 right-2 p-1.5 rounded-full text-white hover:bg-red-700">✖</button>` : ''}
                                        <h3 class="text-xl font-fancy text-purple-300 mb-2">${c.title}</h3>
                                        <p class="text-slate-400 font-sans">${c.description}</p>
                                    </div>
                                `).join('') || `<p class="col-span-full text-slate-500">Nenhum feitiço inscrito nesta sessão ainda.</p>`}
                            </div>
                        </div>
                     `).join('')}
                </div>
            </div>
        `;
        
        const AdminPanel = (state = {}) => `
            <div class="p-6 rounded-xl glass-effect border-green-700/50 mb-8 animate-fade-in space-y-8">
                <div>
                    <h3 class="text-xl font-fancy text-green-300 mb-4">Gerir Aprendizes</h3>
                    ${state.userMessage ? `<div class="p-3 mb-4 text-center font-bold ${state.isUserError ? 'bg-red-900/50 text-red-200' : 'bg-green-900/50 text-green-200'}">${state.userMessage}</div>` : ''}
                    <form id="create-user-form" class="space-y-4">
                        <div class="flex flex-col md:flex-row gap-4">
                            <input name="new-email" type="email" required placeholder="Email do novo cliente" class="flex-grow w-full px-4 py-2 bg-slate-800 rounded-lg" />
                            <input name="new-password" type="password" required placeholder="Senha temporária" class="flex-grow w-full px-4 py-2 bg-slate-800 rounded-lg" />
                        </div>
                        <div class="pt-2">
                            <label class="block mb-2 text-sm font-medium text-gray-300">Conceder Acesso às Sessões:</label>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                                ${Object.keys(SESSIONS).map(key => `
                                    <label class="flex items-center space-x-3 p-3 bg-slate-800/50 rounded-lg">
                                        <input type="checkbox" name="sections" value="${key}" class="w-4 h-4 text-purple-600 bg-gray-700 border-gray-600 rounded">
                                        <span>${SESSIONS[key]}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                        <button type="submit" ${state.isUserLoading ? 'disabled' : ''} class="w-full px-6 py-2 font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700">
                            ${state.isUserLoading ? 'Criando...' : 'Criar Conta'}
                        </button>
                    </form>
                </div>
                <hr class="border-slate-600/50">
                <div>
                    <h3 class="text-xl font-fancy text-green-300 mb-4">Inscrever Novo Feitiço</h3>
                    ${state.postMessage ? `<div class="p-3 mb-4 text-center font-bold ${state.isPostError ? 'bg-red-900/50 text-red-200' : 'bg-green-900/50 text-green-200'}">${state.postMessage}</div>` : ''}
                    <form id="create-post-form" class="space-y-4">
                        <select name="post-section" required class="w-full p-2 bg-slate-800 rounded-lg">
                            <option value="" disabled selected>Selecione a sessão...</option>
                            ${Object.keys(SESSIONS).map(key => `<option value="${key}">${SESSIONS[key]}</option>`).join('')}
                        </select>
                        <input name="post-title" type="text" required placeholder="Título do Feitiço" class="w-full px-4 py-2 bg-slate-800 rounded-lg" />
                        <input name="post-description" type="text" required placeholder="Descrição curta (para o card)" class="w-full px-4 py-2 bg-slate-800 rounded-lg" />
                        <textarea name="post-content" required placeholder="Cole o seu texto aqui. A formatação de títulos e negrito será automática." class="w-full px-4 py-2 bg-slate-800 rounded-lg prose-custom h-40"></textarea>
                        <button type="submit" ${state.isPostLoading ? 'disabled' : ''} class="w-full px-6 py-2 font-semibold text-white bg-purple-600 rounded-lg hover:bg-purple-700">
                             ${state.isPostLoading ? 'Publicando...' : 'Adicionar Feitiço'}
                        </button>
                    </form>
                </div>
            </div>
        `;

         const ClassDetailView = (classItem) => `
            <div class="max-w-4xl mx-auto animate-fade-in">
                <button id="back-to-dashboard" class="mb-8 px-4 py-2 font-semibold text-purple-200 bg-slate-800/80 rounded-lg hover:bg-slate-700"> &larr; Voltar ao Grimório</button>
                <article class="p-6 md:p-8 rounded-2xl glass-effect">
                    <h1 class="text-4xl md:text-5xl font-fancy text-purple-200 mb-4 border-b-2 border-purple-800/50 pb-4">${classItem.title}</h1>
                    <p class="text-slate-400 italic mb-8">${classItem.description}</p>
                    <div class="prose-custom">${autoFormatText(classItem.content)}</div>
                </article>
                ${currentUser?.isAdmin ? `<div class="mt-8 text-right"><button id="delete-post-detail-btn" data-delete-id="${classItem.id}" class="bg-red-800 hover:bg-red-700 font-bold py-2 px-4 rounded-lg">Banir Feitiço</button></div>` : ''}
            </div>
        `;

        const handleLogin = async (email, password) => {
            render(LoginView('', true));
            const q = query(collection(db, "users"), where("email", "==", email), limit(1));
            try {
                const snapshot = await getDocs(q);
                if (snapshot.empty) return render(LoginView('Nenhum iniciado com este email foi encontrado.'));
                const userDoc = snapshot.docs[0].data();
                if (userDoc.passwordHash === simpleHash(password)) {
                    currentUser = { id: snapshot.docs[0].id, ...userDoc };
                    loadDashboard();
                } else {
                    render(LoginView('A senha está incorreta. A magia falhou.'));
                }
            } catch (err) {
                render(LoginView('Um erro arcano ocorreu ao tentar entrar.'));
            }
        };

        const handleLogout = () => {
            currentUser = null;
            isAdminPanelVisible = false;
            render(LoginView());
        };

        const handleCreateUser = async (email, password, sections) => {
            document.getElementById('admin-panel-container').innerHTML = AdminPanel({ isUserLoading: true });
            const q = query(collection(db, "users"), where("email", "==", email), limit(1));
            if (!(await getDocs(q)).empty) {
                return document.getElementById('admin-panel-container').innerHTML = AdminPanel({ userMessage: 'Este email já está em uso.', isUserError: true });
            }
            try {
                await addDoc(collection(db, "users"), {
                    email, passwordHash: simpleHash(password),
                    isAdmin: false, accessibleSections: sections, createdAt: new Date()
                });
                document.getElementById('admin-panel-container').innerHTML = AdminPanel({ userMessage: `Conta criada para ${email}!` });
            } catch (err) {
                document.getElementById('admin-panel-container').innerHTML = AdminPanel({ userMessage: 'Erro ao inscrever o novo aprendiz.', isUserError: true });
            }
        };

        const handleCreatePost = async (sectionId, title, description, content) => {
             document.getElementById('admin-panel-container').innerHTML = AdminPanel({ isPostLoading: true });
             const classesCollectionPath = `artifacts/${appIdName}/public/data/classes`;
             try {
                await addDoc(collection(db, classesCollectionPath), {
                    sectionId, title, description, content, createdAt: new Date()
                });
                document.getElementById('admin-panel-container').innerHTML = AdminPanel({ postMessage: 'Novo feitiço inscrito com sucesso!' });
             } catch(err) {
                document.getElementById('admin-panel-container').innerHTML = AdminPanel({ postMessage: 'Erro ao inscrever o feitiço.', isPostError: true });
             }
        };

        const handleDeletePost = async (postId) => {
            const classesCollectionPath = `artifacts/${appIdName}/public/data/classes`;
            try {
                await deleteDoc(doc(db, classesCollectionPath, postId));
                if (document.getElementById('back-to-dashboard')) loadDashboard();
            } catch (error) {
                alert("Não foi possível excluir o feitiço.");
            }
        };
        
        const handleDeleteClick = (event) => {
            event.stopPropagation();
            const button = event.currentTarget;
            if (confirm(`Tem a certeza que quer banir este feitiço? A ação é irreversível.`)) {
                 handleDeletePost(button.dataset.deleteId);
            }
        };

        const toggleAdminPanel = () => {
            isAdminPanelVisible = !isAdminPanelVisible;
            render(DashboardView());
        };
        
        const showClassDetails = (classId) => {
            const classItem = currentClasses.find(c => c.id === classId);
            if(classItem) render(ClassDetailView(classItem));
        };
        
        const loadDashboard = () => {
            const classesCollectionPath = `artifacts/${appIdName}/public/data/classes`;
            onSnapshot(query(collection(db, classesCollectionPath)), (snapshot) => {
                currentClasses = [];
                snapshot.forEach((doc) => currentClasses.push({ id: doc.id, ...doc.data() }));
                render(DashboardView());
            });
        };

        const attachEventListeners = () => {
            const loginForm = document.getElementById('login-form');
            if (loginForm) loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleLogin(e.target.elements.email.value, e.target.elements.password.value);
            });
            
            document.getElementById('logout-btn')?.addEventListener('click', handleLogout);
            document.getElementById('toggle-admin-panel')?.addEventListener('click', toggleAdminPanel);
            
            const createUserForm = document.getElementById('create-user-form');
            if(createUserForm) createUserForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const sections = Array.from(e.target.elements.sections).filter(c => c.checked).map(c => c.value);
                handleCreateUser(e.target.elements['new-email'].value, e.target.elements['new-password'].value, sections);
            });
            
            const createPostForm = document.getElementById('create-post-form');
            if(createPostForm) createPostForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleCreatePost(e.target.elements['post-section'].value, e.target.elements['post-title'].value, e.target.elements['post-description'].value, e.target.elements['post-content'].value);
            });
            
            document.querySelectorAll('.delete-post-btn, #delete-post-detail-btn').forEach(btn => btn.addEventListener('click', handleDeleteClick));
            document.querySelectorAll('.class-card').forEach(card => card.addEventListener('click', (e) => { if(!e.target.closest('.delete-post-btn')) showClassDetails(card.dataset.classId)}));
            document.getElementById('back-to-dashboard')?.addEventListener('click', () => render(DashboardView()));
        };

        const setupInitialAdminUser = async () => {
            const q = query(collection(db, "users"), where("isAdmin", "==", true), limit(1));
            if ((await getDocs(q)).empty) {
                console.log("Criando admin padrão...");
                await addDoc(collection(db, "users"), {
                    email: "admin@arcano.com",
                    passwordHash: simpleHash("senhaadmin"),
                    isAdmin: true,
                    accessibleSections: Object.keys(SESSIONS),
                    createdAt: new Date()
                });
            }
        };

        // --- NOVO: LÓGICA DAS PARTÍCULAS ---
        const setupParticleCanvas = () => {
            const canvas = document.getElementById('particle-canvas');
            const ctx = canvas.getContext('2d');
            let particles = [];

            const resizeCanvas = () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            };

            const createParticles = () => {
                const particleCount = 25; // Número baixo para ser subtil
                for(let i = 0; i < particleCount; i++) {
                    particles.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height,
                        vx: 0,
                        vy: Math.random() * -0.3 - 0.1, // Movimento lento para cima
                        radius: Math.random() * 1.5 + 0.5,
                        color: `rgba(216, 180, 254, ${Math.random() * 0.5 + 0.2})` // Tons de roxo/lavanda
                    });
                }
            };

            const animateParticles = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles.forEach(p => {
                    p.y += p.vy;
                    if (p.y < -p.radius) {
                        p.y = canvas.height + p.radius;
                        p.x = Math.random() * canvas.width;
                    }

                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                    ctx.fillStyle = p.color;
                    ctx.fill();
                });
                requestAnimationFrame(animateParticles);
            };

            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
            createParticles();
            animateParticles();
        };
        
        main();
    </script>
</body>
</html>
