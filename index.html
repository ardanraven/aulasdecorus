<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Arcano</title>
    
    <!-- Tailwind CSS para o estilo -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fontes do Google -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Estilos customizados -->
    <style>
        body { background-color: #0f172a; }
        .font-fancy { font-family: 'Cinzel', serif; }
        .font-sans { font-family: 'Inter', sans-serif; }
        .animate-spin-slow { animation: spin 3s linear infinite; }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .glass-effect { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(51, 65, 85, 0.4); }
        
        .prose-custom {
            white-space: pre-wrap; 
            word-wrap: break-word;   
        }
        .prose-custom h2 { color: #c4b5fd; font-family: 'Cinzel', serif; margin-top: 1.5em; border-bottom: 1px solid #4a044e; padding-bottom: 0.3em; }
        .prose-custom h3 { color: #a5b4fc; font-family: 'Cinzel', serif; margin-top: 1.2em; font-size: 1.25rem; }
        .prose-custom p, .prose-custom li { color: #d1d5db; line-height: 1.7; margin-top: 1em; }
        .prose-custom textarea { height: 150px; }
        .prose-custom b { font-weight: bold; color: #e5e7eb; }
    </style>
</head>
<body class="font-sans text-gray-300">

    <!-- Fundo de estrelas -->
    <div class="absolute top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-10 z-0"></div>

    <!-- Conteúdo principal da aplicação -->
    <main id="app-container" class="relative z-10 container mx-auto p-4 sm:p-6 md:p-8"></main>

    <!-- Firebase SDKs (Versão Atualizada) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, getDocs, where, limit, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // =====================================================================================
        // CONFIGURAÇÃO DO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCAIQdjGBzPWulP2KQcHHmI2r3FgpTfsfg",
            authDomain: "portalarcano-9a0fa.firebaseapp.com",
            projectId: "portalarcano-9a0fa",
            storageBucket: "portalarcano-9a0fa.appspot.com",
            messagingSenderId: "139414169635",
            appId: "1:139414169635:web:31e3a9669c6c08566a2996",
            measurementId: "G-V5SLG68Z6M"
        };
        // =====================================================================================

        const appIdName = 'default-grimorio-pago-html';
        const appContainer = document.getElementById('app-container');
        
        let db;
        let currentUser = null; 
        let currentClasses = [];
        let isAdminPanelVisible = false;
        let confirmationTimeout = null;

        // --- FUNÇÃO DE HASHING SIMPLES PARA SENHAS ---
        const simpleHash = (str) => {
            let hash = 0;
            if (str.length === 0) return hash.toString();
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = (hash << 5) - hash + char;
                hash &= hash; 
            }
            return hash.toString();
        };

        // --- NOVO: FUNÇÃO PARA PARSE DE MARKDOWN SIMPLES ---
        const parseSimpleMarkdown = (text) => {
            if (!text) return '';
            let html = text
                // Escapa HTML para segurança antes de processar
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
            
            // Converte **texto** para <b>texto</b>
            html = html.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
            
            // Converte ### Título para <h3>Título</h3>
            html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');

            // Envolve parágrafos em tags <p>
            html = html.split(/\r?\n/).map(line => {
                if (line.trim() === '') return ''; // Mantém linhas vazias como estão (para espaçamento)
                if (line.startsWith('<h3>')) return line; // Não envolve títulos em <p>
                return `<p>${line}</p>`;
            }).join('');
            
            return html;
        };


        // --- FUNÇÃO PRINCIPAL DE INICIALIZAÇÃO ---
        async function main() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                await setupInitialAdminUser();
                render(LoginView());
            } catch (error) {
                console.error("ERRO CRÍTICO NA INICIALIZAÇÃO DO FIREBASE:", error);
                appContainer.innerHTML = `<div class="text-center text-red-400 p-8">Erro Crítico: Não foi possível conectar ao Firebase. Verifique a consola e as regras de segurança.</div>`;
            }
        }

        // --- RENDERIZAÇÃO E LÓGICA ---
        const render = (template) => {
            appContainer.innerHTML = template;
            attachEventListeners();
        };
        
        // --- TEMPLATES HTML ---
        
        const LoginView = (error = '', loading = false) => `
            <div class="flex items-center justify-center min-h-[90vh]">
                <div class="w-full max-w-md p-8 space-y-6 rounded-2xl shadow-2xl shadow-purple-950/40 glass-effect">
                    <div class="text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto h-12 w-12 text-purple-400"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
                        <h1 class="text-4xl font-fancy mt-4 text-purple-200">Portal Arcano</h1>
                        <p class="text-purple-400 mt-2">Acesso restrito aos iniciados.</p>
                    </div>
                    <form id="login-form" class="space-y-4">
                        ${error ? `<p class="bg-red-900/50 text-red-300 border border-red-700 p-3 rounded-lg text-center font-semibold">${error}</p>` : ''}
                        <input name="email" id="email" type="email" required class="w-full px-4 py-3 text-gray-200 bg-slate-800/80 border border-slate-600 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="seu.email@arcano.com" />
                        <input name="password" id="password" type="password" required class="w-full px-4 py-3 text-gray-200 bg-slate-800/80 border border-slate-600 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="••••••••" />
                        <button type="submit" ${loading ? 'disabled' : ''} class="w-full py-3 font-bold tracking-wider text-lg text-white bg-purple-700 rounded-lg hover:bg-purple-800 transition-transform transform hover:scale-105 disabled:bg-slate-600">
                            ${loading ? `<span>Invocando...</span>` : 'Entrar'}
                        </button>
                    </form>
                </div>
            </div>
        `;

        const DashboardView = () => `
            <div class="animate-fade-in">
                <header class="flex justify-between items-center mb-10 pb-4 border-b border-slate-700/50">
                    <div class="flex items-center gap-3"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-8 w-8 text-purple-300"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg><h1 class="text-3xl md:text-4xl font-fancy text-purple-200">Aulas Decorus</h1></div>
                    <div class="flex items-center gap-3">
                        ${currentUser?.isAdmin ? `<button id="toggle-admin-panel" title="Painel do Arcanista" class="p-2 font-semibold text-white rounded-full transition-colors ${isAdminPanelVisible ? 'bg-purple-600' : 'bg-green-700 hover:bg-green-600'}"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 18v3c0 .6.4 1 1 1h4v-3h3v-3h2l1.4-1.4a6.5 6.5 0 1 0-4-4Z"/><circle cx="16.5" cy="7.5" r=".5"/></svg></button>` : ''}
                        <button id="logout-btn" class="px-4 py-2 font-semibold text-purple-200 bg-slate-800 border border-slate-700 rounded-lg hover:bg-slate-700 transition">Sair</button>
                    </div>
                </header>
                <div id="admin-panel-container">
                    ${currentUser?.isAdmin && isAdminPanelVisible ? AdminPanel() : ''}
                </div>
                <div id="classes-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mt-8">
                     ${currentClasses.length > 0 ? currentClasses.map(c => `
                        <div data-class-id="${c.id}" class="class-card group relative p-6 rounded-xl shadow-lg shadow-purple-950/30 cursor-pointer transition-all duration-300 hover:shadow-2xl hover:shadow-purple-800/40 hover:-translate-y-2 glass-effect">
                            ${currentUser?.isAdmin ? `<button data-delete-id="${c.id}" data-delete-state="initial" class="delete-post-btn z-20 absolute top-2 right-2 bg-slate-700/80 p-1.5 rounded-full text-white hover:bg-red-700 transition leading-none text-xs">✖</button>` : ''}
                            <h2 class="text-2xl font-fancy text-purple-300 mb-2">${c.title}</h2>
                            <p class="text-slate-400 font-sans">${c.description}</p>
                        </div>`).join('') : '<p class="col-span-full text-center text-slate-400">Nenhum feitiço foi inscrito neste grimório ainda.</p>'}
                </div>
            </div>
        `;
        
        const AdminPanel = (state = {}) => `
            <div class="p-6 rounded-xl glass-effect border-green-700/50 mb-8 animate-fade-in space-y-8">
                <!-- Secção de Criação de Utilizadores -->
                <div>
                    <h3 class="text-xl font-fancy text-green-300 mb-4">Gerir Aprendizes</h3>
                    ${state.userMessage ? `<div class="p-3 rounded-lg mb-4 text-center font-bold ${state.isUserError ? 'bg-red-900/50 text-red-200' : 'bg-green-900/50 text-green-200'}">${state.userMessage}</div>` : ''}
                    <form id="create-user-form" class="flex flex-col md:flex-row gap-4 items-center">
                        <input name="new-email" type="email" required placeholder="Email do novo cliente" class="flex-grow w-full px-4 py-2 text-gray-200 bg-slate-800 rounded-lg" />
                        <input name="new-password" type="password" required placeholder="Senha temporária" class="flex-grow w-full px-4 py-2 text-gray-200 bg-slate-800 rounded-lg" />
                        <button type="submit" ${state.isUserLoading ? 'disabled' : ''} class="w-full md:w-auto px-6 py-2 font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700 transition disabled:bg-slate-600">
                            ${state.isUserLoading ? 'Criando...' : 'Criar Conta'}
                        </button>
                    </form>
                </div>

                <hr class="border-slate-600/50">

                <!-- Secção de Criação de Posts -->
                <div>
                    <h3 class="text-xl font-fancy text-green-300 mb-4">Inscrever Novo Feitiço (Post)</h3>
                    ${state.postMessage ? `<div class="p-3 rounded-lg mb-4 text-center font-bold ${state.isPostError ? 'bg-red-900/50 text-red-200' : 'bg-green-900/50 text-green-200'}">${state.postMessage}</div>` : ''}
                    <form id="create-post-form" class="space-y-4">
                        <input name="post-title" type="text" required placeholder="Título do Feitiço" class="w-full px-4 py-2 text-gray-200 bg-slate-800 rounded-lg" />
                        <input name="post-description" type="text" required placeholder="Descrição curta (para o card)" class="w-full px-4 py-2 text-gray-200 bg-slate-800 rounded-lg" />
                        <textarea name="post-content" required placeholder="Conteúdo completo do feitiço (use ### para títulos e ** para negrito)" class="w-full px-4 py-2 text-gray-200 bg-slate-800 rounded-lg prose-custom"></textarea>
                        <button type="submit" ${state.isPostLoading ? 'disabled' : ''} class="w-full px-6 py-2 font-semibold text-white bg-purple-600 rounded-lg hover:bg-purple-700 transition disabled:bg-slate-600">
                             ${state.isPostLoading ? 'Publicando...' : 'Adicionar Feitiço'}
                        </button>
                    </form>
                </div>
            </div>
        `;

         const ClassDetailView = (classItem) => `
            <div class="max-w-4xl mx-auto animate-fade-in">
                <button id="back-to-dashboard" class="mb-8 px-4 py-2 font-semibold text-purple-200 bg-slate-800/80 border border-slate-700 rounded-lg hover:bg-slate-700 transition flex items-center gap-2">
                    &larr; Voltar ao Grimório
                </button>
                <article class="p-6 md:p-8 rounded-2xl shadow-inner shadow-purple-950/50 glass-effect">
                    <h1 class="text-4xl md:text-5xl font-fancy text-purple-200 mb-4 border-b-2 border-purple-800/50 pb-4">${classItem.title}</h1>
                    <p class="text-slate-400 italic mb-8">${classItem.description}</p>
                    <div class="prose-custom">${parseSimpleMarkdown(classItem.content)}</div>
                </article>
                ${currentUser?.isAdmin ? `
                <div class="mt-8 text-right">
                    <button id="delete-post-detail-btn" data-delete-id="${classItem.id}" data-delete-state="initial" class="bg-red-800 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-all duration-300">
                        Banir Feitiço
                    </button>
                </div>
                ` : ''}
            </div>
        `;

        // --- LÓGICA DE AUTENTICAÇÃO E DADOS ---
        const handleLogin = async (email, password) => {
            render(LoginView('', true));
            const usersRef = collection(db, "users");
            const q = query(usersRef, where("email", "==", email), limit(1));
            
            try {
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    render(LoginView('Nenhum iniciado com este email foi encontrado.'));
                    return;
                }
                const userDoc = querySnapshot.docs[0].data();
                if (userDoc.passwordHash === simpleHash(password)) {
                    currentUser = { id: querySnapshot.docs[0].id, ...userDoc };
                    loadDashboard();
                } else {
                    render(LoginView('A senha está incorreta. A magia falhou.'));
                }
            } catch (err) {
                render(LoginView('Um erro arcano ocorreu ao tentar entrar.'));
            }
        };

        const handleLogout = () => {
            currentUser = null;
            isAdminPanelVisible = false;
            render(LoginView());
        };

        const handleCreateUser = async (email, password) => {
            document.getElementById('admin-panel-container').innerHTML = AdminPanel({ isUserLoading: true });
            const usersRef = collection(db, "users");
            const q = query(usersRef, where("email", "==", email), limit(1));
            const existingUser = await getDocs(q);

            if (!existingUser.empty) {
                document.getElementById('admin-panel-container').innerHTML = AdminPanel({ userMessage: 'Este email já está em uso.', isUserError: true });
                return;
            }
            try {
                await addDoc(usersRef, {
                    email: email,
                    passwordHash: simpleHash(password),
                    isAdmin: false,
                    createdAt: new Date()
                });
                document.getElementById('admin-panel-container').innerHTML = AdminPanel({ userMessage: `Conta criada para ${email}!` });
            } catch (err) {
                document.getElementById('admin-panel-container').innerHTML = AdminPanel({ userMessage: 'Erro ao inscrever o novo aprendiz.', isUserError: true });
            }
        };

        const handleCreatePost = async (title, description, content) => {
             document.getElementById('admin-panel-container').innerHTML = AdminPanel({ isPostLoading: true });
             const classesRef = collection(db, `artifacts/${appIdName}/public/data/classes`);
             try {
                await addDoc(classesRef, {
                    title,
                    description,
                    content,
                    createdAt: new Date()
                });
                document.getElementById('admin-panel-container').innerHTML = AdminPanel({ postMessage: 'Novo feitiço inscrito com sucesso!' });
             } catch(err) {
                console.error("Erro ao criar post:", err);
                document.getElementById('admin-panel-container').innerHTML = AdminPanel({ postMessage: 'Erro ao inscrever o feitiço.', isPostError: true });
             }
        };

        const handleDeletePost = async (postId) => {
            try {
                const postRef = doc(db, `artifacts/${appIdName}/public/data/classes`, postId);
                await deleteDoc(postRef);
                if (document.getElementById('back-to-dashboard')) {
                    loadDashboard();
                }
            } catch (error) {
                console.error("Erro ao excluir o post:", error);
                alert("Não foi possível excluir o feitiço. Um erro arcano ocorreu.");
            }
        };
        
        // --- GERENCIADORES DE EVENTOS E NAVEGAÇÃO ---
        const resetDeleteButtons = () => {
            document.querySelectorAll('[data-delete-state="confirm"]').forEach(btn => {
                btn.dataset.deleteState = 'initial';
                if (btn.id === 'delete-post-detail-btn') {
                    btn.textContent = "Banir Feitiço";
                    btn.classList.remove('bg-red-500');
                    btn.classList.add('bg-red-800');
                } else {
                    btn.innerHTML = '✖';
                    btn.classList.remove('bg-red-500');
                    btn.classList.add('bg-slate-700/80');
                }
            });
            if (confirmationTimeout) clearTimeout(confirmationTimeout);
        };

        const handleDeleteClick = (event) => {
            event.stopPropagation();
            const button = event.currentTarget;
            if (button.dataset.deleteState === 'initial') {
                resetDeleteButtons();
                button.dataset.deleteState = 'confirm';
                if (button.id === 'delete-post-detail-btn') {
                    button.textContent = "Confirmar Exclusão?";
                    button.classList.remove('bg-red-800');
                    button.classList.add('bg-red-500');
                } else {
                    button.innerHTML = '✔';
                    button.classList.remove('bg-slate-700/80');
                    button.classList.add('bg-red-500');
                }
                confirmationTimeout = setTimeout(resetDeleteButtons, 4000);
            } else if (button.dataset.deleteState === 'confirm') {
                resetDeleteButtons();
                handleDeletePost(button.dataset.deleteId);
            }
        };

        const toggleAdminPanel = () => {
            isAdminPanelVisible = !isAdminPanelVisible;
            render(DashboardView());
        };
        
        const showClassDetails = (classId) => {
            const classItem = currentClasses.find(c => c.id === classId);
            if(classItem) render(ClassDetailView(classItem));
        };
        
        const loadDashboard = () => {
            const classesCollectionPath = `artifacts/${appIdName}/public/data/classes`;
            const q = query(collection(db, classesCollectionPath));
            const unsubscribe = onSnapshot(q, (querySnapshot) => {
                currentClasses = [];
                querySnapshot.forEach((doc) => {
                    currentClasses.push({ id: doc.id, ...doc.data() });
                });
                render(DashboardView());
            }, (error) => {
                console.error("Erro ao buscar aulas:", error);
                render(DashboardView());
            });
        };

        const attachEventListeners = () => {
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', (event) => {
                    event.preventDefault();
                    const email = loginForm.elements.email.value;
                    const password = loginForm.elements.password.value;
                    handleLogin(email, password);
                });
            }
            
            const logoutBtn = document.getElementById('logout-btn');
            if(logoutBtn) logoutBtn.addEventListener('click', handleLogout);
            
            const toggleAdminBtn = document.getElementById('toggle-admin-panel');
            if(toggleAdminBtn) toggleAdminBtn.addEventListener('click', toggleAdminPanel);
            
            const createUserForm = document.getElementById('create-user-form');
            if(createUserForm) {
                createUserForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const email = createUserForm.elements['new-email'].value;
                    const password = createUserForm.elements['new-password'].value;
                    handleCreateUser(email, password);
                });
            }
            
            const createPostForm = document.getElementById('create-post-form');
            if(createPostForm) {
                createPostForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const title = createPostForm.elements['post-title'].value;
                    const description = createPostForm.elements['post-description'].value;
                    const content = createPostForm.elements['post-content'].value;
                    handleCreatePost(title, description, content);
                });
            }
            
            document.querySelectorAll('.delete-post-btn, #delete-post-detail-btn').forEach(btn => btn.addEventListener('click', handleDeleteClick));
            document.querySelectorAll('.class-card').forEach(card => card.addEventListener('click', (e) => { if(!e.target.closest('.delete-post-btn')) showClassDetails(card.dataset.classId)}));
            
            const backBtn = document.getElementById('back-to-dashboard');
            if(backBtn) backBtn.addEventListener('click', () => render(DashboardView()));
        };

        // --- CONFIGURAÇÃO INICIAL DO ADMIN ---
        const setupInitialAdminUser = async () => {
            const usersRef = collection(db, "users");
            const q = query(usersRef, where("isAdmin", "==", true), limit(1));
            const snapshot = await getDocs(q);
            if (snapshot.empty) {
                console.log("Nenhum admin encontrado. Criando admin padrão...");
                await addDoc(usersRef, {
                    email: "admin@arcano.com",
                    passwordHash: simpleHash("senhaadmin"),
                    isAdmin: true,
                    createdAt: new Date()
                });
                console.log("Admin padrão criado com email: admin@arcano.com e senha: senhaadmin");
            }
        };
        
        // --- Inicia a aplicação ---
        main();
    </script>
</body>
</html>
